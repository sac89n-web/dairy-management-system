@page
@model PaymentsModel

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-wallet text-primary"></i> Payments & Ledger</h2>
        <p class="text-muted">Manage farmer and customer payment records</p>
    </div>
    <div>
        <button class="btn btn-success me-2" onclick="location.href='/PaymentManagement'">
            <i class="fas fa-credit-card"></i> Advanced Payments
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
            <i class="fas fa-plus"></i> Add Payment
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5>Total Farmer Payments</h5>
                <h3>₹@Model.FarmerPayments.Sum(x => x.Amount).ToString("N0")</h3>
                <small>@Model.FarmerPayments.Count records</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5>Total Customer Payments</h5>
                <h3>₹@Model.CustomerPayments.Sum(x => x.Amount).ToString("N0")</h3>
                <small>@Model.CustomerPayments.Count records</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h5>Today's Payments</h5>
                <h3>₹@((Model.FarmerPayments.Where(x => DateTime.TryParse(x.Date, out var d) && d.Date == DateTime.Today).Sum(x => x.Amount) + Model.CustomerPayments.Where(x => DateTime.TryParse(x.Date, out var d2) && d2.Date == DateTime.Today).Sum(x => x.Amount)).ToString("N0"))</h3>
                <small>@DateTime.Today.ToString("dd MMM yyyy")</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5>Net Balance</h5>
                <h3>₹@((Model.CustomerPayments.Sum(x => x.Amount) - Model.FarmerPayments.Sum(x => x.Amount)).ToString("N0"))</h3>
                <small>Customer - Farmer</small>
            </div>
        </div>
    </div>
</div>

<!-- Farmer Payments -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-user-tie text-success"></i> Farmer Payments</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Farmer</th>
                        <th>Collection</th>
                        <th>Amount</th>
                        <th>Invoice</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.FarmerPayments.OrderByDescending(x => DateTime.TryParse(x.Date, out var d) ? d : DateTime.MinValue))
                    {
                        <tr>
                            <td>@(DateTime.TryParse(item.Date, out var d) ? d.ToString("dd/MM/yyyy") : item.Date)</td>
                            <td>Farmer #@item.FarmerId</td>
                            <td>Collection #@item.MilkCollectionId</td>
                            <td><strong>₹@item.Amount.ToString("N2")</strong></td>
                            <td><span class="badge bg-secondary">@item.InvoiceNo</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewPayment('farmer', @item.Id)">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                    }
                    @if(!Model.FarmerPayments.Any())
                    {
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                No farmer payments found
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Customer Payments -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-users text-info"></i> Customer Payments</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Sale</th>
                        <th>Amount</th>
                        <th>Invoice</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.CustomerPayments.OrderByDescending(x => DateTime.TryParse(x.Date, out var d) ? d : DateTime.MinValue))
                    {
                        <tr>
                            <td>@(DateTime.TryParse(item.Date, out var d) ? d.ToString("dd/MM/yyyy") : item.Date)</td>
                            <td>Customer #@item.CustomerId</td>
                            <td>Sale #@item.SaleId</td>
                            <td><strong>₹@item.Amount.ToString("N2")</strong></td>
                            <td><span class="badge bg-secondary">@item.InvoiceNo</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewPayment('customer', @item.Id)">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                    }
                    @if(!Model.CustomerPayments.Any())
                    {
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                No customer payments found
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Payment Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <div class="mb-3">
                        <label class="form-label">Payment Type</label>
                        <select class="form-select" id="paymentType">
                            <option value="farmer">Farmer Payment</option>
                            <option value="customer">Customer Payment</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount (₹)</label>
                        <input type="number" class="form-control" id="amount" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="paymentDate" value="@DateTime.Today.ToString("yyyy-MM-dd")" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Invoice Number</label>
                        <input type="text" class="form-control" id="invoiceNo" placeholder="Auto-generated if empty">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePayment()">Save Payment</button>
            </div>
        </div>
    </div>
</div>

<script>
function viewPayment(type, id) {
    alert(`Viewing ${type} payment #${id}`);
}

function savePayment() {
    const type = document.getElementById('paymentType').value;
    const amount = document.getElementById('amount').value;
    const date = document.getElementById('paymentDate').value;
    const invoice = document.getElementById('invoiceNo').value;
    
    if (!amount || !date) {
        alert('Please fill all required fields');
        return;
    }
    
    alert(`Payment record saved:\nType: ${type}\nAmount: ₹${amount}\nDate: ${date}`);
    location.reload();
}
</script>
